services:
  node.omne.open:
    build: 
      context: .
      dockerfile: Dockerfile.open_node  # Using Dockerfile.open_node for open-source node
    image: omne-node:open-source
    container_name: node.omne.open
    ports:
      - "${OPEN_HOST_PORT:-3401}:3400"  # Default to 3401 if OPEN_HOST_PORT not set
    networks:
      - omne_node_eaies-net
      - omne_node_hash-api-net
    volumes:
      - ./app:/app
    labels:
      app: omne-node-open
      level: blockchain
      role: participant
      tier: backend
      track: continuous
    environment:
      - PYTHONPATH=/app
      - NODE_ENV=${NODE_ENV:-development}
      - PORT_NUMBER=${PORT_NUMBER:-3400}
      - NODE_ID=${NODE_ID:-node1}  # Add NODE_ID environment variable
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: '4G'
        reservations:
          cpus: '1.0'
          memory: '2G'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3400/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5

networks:
  omne_node_eaies-net:
    external: true
  omne_node_hash-api-net:
    external: true
